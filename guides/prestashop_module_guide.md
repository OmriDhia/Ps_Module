# PrestaShop Module Development Guide (1.7, 8, & 9)

**Role:** Expert PrestaShop Developer & Architect
**Context:** Based strictly on official documentation for PrestaShop 1.7, 8, and 9.

---

## üß± 1. PrestaShop Module Code Structure

A clean, standard structure is critical for maintainability and compatibility across versions.

### 1.1 Standard Directory Structure

For all supported versions (1.7.x, 8.x, 9.x), the root of your module must contain the main PHP file (`modulename.php`) and `composer.json` is highly recommended for autoloading commands and services.

#### Recommended Layout (Modern Compatible)

```
modulename/
‚îú‚îÄ‚îÄ composer.json               # Dependencies & Autoloading rules
‚îú‚îÄ‚îÄ modulename.php              # Main class (extends Module)
‚îú‚îÄ‚îÄ config.xml                  # (Auto-generated by XML export, do not edit manually)
‚îú‚îÄ‚îÄ logo.png                    # 32x32 icon
‚îú‚îÄ‚îÄ src/                        # MODERN: PHP Classes (PSR-4)
‚îÇ   ‚îú‚îÄ‚îÄ Controller/             # Symfony Controllers (Back Office)
‚îÇ   ‚îú‚îÄ‚îÄ Entity/                 # Doctrine Entities (or Legacy ObjectModels)
‚îÇ   ‚îú‚îÄ‚îÄ Repository/             # Doctrine Repositories
‚îÇ   ‚îú‚îÄ‚îÄ Form/                   # Symfony Forms
‚îÇ   ‚îî‚îÄ‚îÄ Grid/                   # Grid Definitions (Modern BO Lists)
‚îú‚îÄ‚îÄ controllers/                # LEGACY: Front & Admin Controllers
‚îÇ   ‚îú‚îÄ‚îÄ admin/
‚îÇ   ‚îî‚îÄ‚îÄ front/
‚îú‚îÄ‚îÄ views/                      # Templates & Assets
‚îÇ   ‚îú‚îÄ‚îÄ css/
‚îÇ   ‚îú‚îÄ‚îÄ js/
‚îÇ   ‚îú‚îÄ‚îÄ img/
‚îÇ   ‚îî‚îÄ‚îÄ templates/
‚îÇ       ‚îú‚îÄ‚îÄ admin/
‚îÇ       ‚îú‚îÄ‚îÄ front/
‚îÇ       ‚îî‚îÄ‚îÄ hook/
‚îî‚îÄ‚îÄ upgrade/                    # Upgrade scripts (upgrade-X.Y.Z.php)
```

### 1.2 Version Differences

*   **PrestaShop 1.7**: Hybrid architecture. Supports both Legacy Controllers (`controllers/admin`) and Symfony Controllers (`src/Controller`). Logic often mixed in `modulename.php`.
*   **PrestaShop 8 & 9**: Stronger emphasis on "Modern" architecture. Commands, Queries, and Handlers (CQRS) are first-class citizens.
    *   **Recommendation**: Place all business logic in `src/` using namespaces (e.g., `PrestaShop\Module\ModuleName\...`).
    *   **Legacy**: Keep `controllers/` only for Front Office controllers (until a fully modernized Front stack is standard) or legacy Admin tabs.

---

## üß† 2. CQRS Pattern in PrestaShop Modules

**CQRS** (Command Query Responsibility Segregation) separates **Write** operations (Commands) from **Read** operations (Queries).

### 2.1 When to use CQRS?
*   **Use it**: For complex business logic, creating new API endpoints (PS 9), or massive bulk operations. It decouples your Logic from the Controller.
*   **Don't use it**: For simple "CRUD" on a single database table where standard ObjectModel suffices and you don't need transactional safety or complex validation.

### 2.2 Components & Rules (Strictly from Docs)

#### Commands (Write)
*   **Definition**: Describes a *single* intent to change state (e.g., `AddAttributeGroupCommand`).
*   **Rules**:
    *   Must be **Immutable**.
    *   Contains only primitive types (int, string, bool, array).
    *   **NO** business logic inside.

#### Queries (Read)
*   **Definition**: Describes a request for data (e.g., `GetAttributeGroupForEditing`).
*   **Rules**:
    *   Must be **Immutable**.
    *   Contains only primitives (filtering criteria, IDs).

#### Handlers (The Logic)
*   **Command Handler**:
    *   Executes the Command.
    *   Should **NOT** return data (void), except for IDs on creation.
    *   Should throw Typed Exceptions on failure.
*   **Query Handler**:
    *   Returns a specific DTO (Data Transfer Object) or array.
    *   Should **NOT** return "Internal" objects (like Doctrine Entities) directly to the controller; map them to a DTO first.

### 2.3 Implementation Example Structure

```
src/
‚îî‚îÄ‚îÄ Domain/
    ‚îî‚îÄ‚îÄ Order/
        ‚îú‚îÄ‚îÄ Command/
        ‚îÇ   ‚îú‚îÄ‚îÄ CancelOrderCommand.php
        ‚îÇ   ‚îî‚îÄ‚îÄ CancelOrderCommandHandler.php
        ‚îú‚îÄ‚îÄ Query/
        ‚îÇ   ‚îú‚îÄ‚îÄ GetOrderDetails.php
        ‚îÇ   ‚îî‚îÄ‚îÄ GetOrderDetailsHandler.php
        ‚îî‚îÄ‚îÄ Exception/
            ‚îî‚îÄ‚îÄ OrderNotFoundException.php
```

> **Note**: In PrestaShop Core, `Command` classes are often in `Core/Domain` and handlers in `Adapter/` (if using Legacy code). Inside a **Module**, you can keep them together in `src/Domain` or `src/Application`.

---

## üß© 3. DDD (Domain-Driven Design) in PrestaShop Modules

DDD helps organize code around the "Business Language" rather than technical artifacts.

### 3.1 Layers in a Module context

1.  **Domain Layer** (`src/Domain/`)
    *   **What**: The "Heart" of your software.
    *   **Contains**:
        *   **Value Objects**: Typed settings (e.g., `EmailAddress`, `Price`).
        *   **Interfaces**: Contracts for Repositories (e.g., `OrderRepositoryInterface`).
        *   **Exceptions**: Business errors (e.g., `InvalidCartException`).
    *   *Constraint*: No dependencies on PrestaShop Core classes (Cookie, Context) if possible.

2.  **Application Layer** (`src/Application/`)
    *   **What**: Orchestrates tasks.
    *   **Contains**: CQRS Commands/Queries, Event Subscribers.

3.  **Infrastructure Layer** (`src/Infrastructure/`)
    *   **What**: Technical implementation.
    *   **Contains**:
        *   **Doctrine Repositories** (Implementing Domain Interfaces).
        *   **Legacy Adapters**: Wrappers around `ObjectModel` or `Db::getInstance()`.

### 3.2 Compatibility
*   **PS 1.7**: You can use DDD namespaces manually in `src/`. Requires stricter self-discipline as the Core doesn't enforce it as much.
*   **PS 8/9**: The Core architecture itself moved to DDD (`Core/Domain`). Your module should mirror this structure for easier integration with Core services.

---

## ‚úÖ 4. Module Validity & Compliance

To pass validation (PrestaShop Addons or strict QA), your module **must** adhere to these rules (from `techvalidation-checklist.md`).
=> Upload your zip to [validator.prestashop.com](https://validator.prestashop.com) (mentioned in docs).

### 4.1 Mandatory Requirements
1.  **`index.php`**: Every folder (including subfolders like `img`, `css`) MUST contain an `index.php` file to prevent directory listing.
2.  **License**: Must be compatible (Apache, MIT, AFL).
3.  **English Code**: Variables, comments, and function names MUST be in English.
4.  **No Direct Core Alteration**: Never modify core files. Use **Hooks** or **Overrides** (Overrides discouraged in modern PS).

### 4.2 Security Checklist
*   **SQL Injection**:
    *   Legacy: Use `pSQL($var)` for strings, `(int)$var` for integers.
    *   Modern: Use Doctrine (Prepared statements are automatic).
*   **XSS**:
    *   Templates: Escape output (`{$var|escape:'html':'UTF-8'}`).
*   **Exec/Eval**: Strictly Forbidden.
*   **Check Tokens**: All AJAX/Form submissions must verify a security token.

---

## üîç 5. Code Validation, Review & Quality Control

Use these tools to ensure your module meets the standards defined above.

### 5.1 Automated Tools

1.  **PHP-CS-Fixer**: Enforce PrestaShop coding standards.
    *   *Usage*: `vendor/bin/php-cs-fixer fix src/`
    *   *Config*: Use the official [PrestaShop CS Fixer Config](https://github.com/PrestaShop/php-dev-tools).

2.  **PHPStan**: Static Analysis to find type errors.
    *   *Usage*: `vendor/bin/phpstan analyse src/ --level=5`
    *   *Module*: Use `prestashop/php-dev-tools` which provides a PHPStan extension for PrestaShop.

3.  **PrestaShop Validator**:
    *   Upload your zip to [validator.prestashop.com](https://validator.prestashop.com) (mentioned in docs).

### 5.2 Manual Review Checklist

- [ ] **Structure**: Is logic separated from the Controller?
- [ ] **CQRS**: Are Commands immutable? Do Handlers return `void` (for commands)?
- [ ] **Security**: Are all `Tools::getValue()` cast or sanitized?
- [ ] **Performance**:
    - [ ] No queries inside loops (N+1 problem).
    - [ ] JS/CSS assets added only on relevant pages (not global hook).
- [ ] **Cleanliness**: No commented-out code, no `var_dump()` left behind.
